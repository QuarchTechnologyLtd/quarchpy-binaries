name: Build QuarchPy Binaries

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  id-token: write # Required for PyPI Trusted Publishing

jobs:
  package-quarchpy:
    name: Package QuarchPy (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          #
          # Windows
          #
          - os: windows-latest
            os_short: win
            jre_suffix: win_amd64_jdk_jre
            qps_zip: qps-release-windows.zip
            plat_name: win_amd64
          #
          # Linux x86
          #
          - os: ubuntu-latest
            os_short: lin
            jre_suffix: lin_amd64_jdk_jre
            qps_zip: qps-release-debian.zip
            plat_name: manylinux2014_x86_64
          #
          # Linux ARM
          #
          - os: ubuntu-latest
            os_short: lin-arm
            jre_suffix: lin_arm64_jdk_jre
            qps_zip: qps-release-debian.zip
            plat_name: manylinux2014_aarch64
          #
          # macOS Intel
          #
          - os: macos-15-intel
            os_short: mac
            jre_suffix: mac_amd64_jdk_jre
            qps_zip: qps-release-mac-intel.zip
            plat_name: macosx_10_9_x86_64
          #
          # macOS ARM
          #
          - os: macos-15
            os_short: mac-arm
            jre_suffix: mac_arm64_jdk_jre
            qps_zip: qps-release-macos-arm.zip
            plat_name: macosx_11_0_arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      #
      # 1. Download JREs
      #
      - name: Download JRE Bundle
        env:
          GH_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}
        shell: bash
        run: |
          mkdir -p src/quarchpy_binaries/dependencies/jre
          
          echo "Downloading latest JRE for ${{ matrix.os }}..."
          gh release download \
            --repo QuarchTechnologyLtd/JRE-Tool \
            --pattern "${{ matrix.jre_suffix }}.zip" \
            --dir src/quarchpy_binaries/dependencies/jre

      # #
      # # 2. Download QPS
      # #
      # - name: Download QPS Binaries
      #   env:
      #     GH_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}
      #   shell: bash
      #   run: |
      #     mkdir -p src/quarchpy_binaries/dependencies/qps
          
      #     echo "Downloading latest QPS binaries for ${{ matrix.os }}..."
      #     gh release download \
      #       --repo QuarchTechnologyLtd/QPS \
      #       --pattern "${{ matrix.qps_zip }}" \
      #       --dir src/quarchpy_binaries/dependencies/qps

      #
      # 3. Extract JRE
      #
      - name: Extract JRE
        shell: bash
        run: |
          cd src/quarchpy_binaries/dependencies/jre
          unzip -q "${{ matrix.jre_suffix }}.zip"
          rm "${{ matrix.jre_suffix }}.zip"
          echo "JRE Extracted to src/quarchpy_binaries/dependencies/jre/${{ matrix.jre_suffix }}"

      # #
      # # 4. Extract QPS
      # #
      # - name: Extract QPS
      #   shell: bash
      #   run: |
      #     cd src/quarchpy_binaries/dependencies/qps
      #     unzip -q "${{ matrix.qps_zip }}"
      #     rm "${{ matrix.qps_zip }}"
      #     echo "QPS Extracted to src/quarchpy_binaries/dependencies/qps"

      #
      # 5. Build Package (Wheel only)
      #
      - name: Install Build Tools
        run: pip install setuptools wheel

      - name: Build Wheel
        # This will now correctly produce: 
        # quarchpy_binaries-0.0.3-py3-none-[matrix.plat_name].whl
        run: python setup.py bdist_wheel --plat-name ${{ matrix.plat_name }}

      #
      # 6. Upload Artifacts (Instead of Publishing directly)
      #
      - name: Upload Wheel
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.os_short }}
          path: dist/*.whl

  #
  # Separate Publish Job (Must run on Linux)
  #
  publish:
    name: Publish to PyPI
    needs: package-quarchpy
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          pattern: dist-*
          merge-multiple: true
          path: dist

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_TOKEN }}
          packages_dir: dist
